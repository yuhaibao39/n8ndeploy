<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>访客管理系统</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/element-ui@2.15.13/lib/theme-chalk/index.css">
    <style>
        .container {
            padding: 20px;
        }
        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="container">
            <el-tabs v-model="activeTab">
                <el-tab-pane label="访客登记" name="register">
                    <div class="form-container">
                        <el-form :model="visitorForm" :rules="rules" ref="visitorForm" label-width="100px">
                            <el-form-item label="访客姓名" prop="name">
                                <el-input v-model="visitorForm.name"></el-input>
                            </el-form-item>
                            <el-form-item label="手机号" prop="phone">
                                <el-input v-model="visitorForm.phone"></el-input>
                            </el-form-item>
                            <el-form-item label="身份证号" prop="idCard">
                                <el-input v-model="visitorForm.idCard"></el-input>
                            </el-form-item>
                            <el-form-item label="来访目的" prop="purpose">
                                <el-input type="textarea" v-model="visitorForm.purpose"></el-input>
                            </el-form-item>
                            <el-form-item label="车牌号" prop="carNumber">
                                <el-input v-model="visitorForm.carNumber"></el-input>
                            </el-form-item>
                            <el-form-item label="被访人" prop="employeeId">
                                <el-select v-model="visitorForm.employeeId" filterable placeholder="请选择被访人">
                                    <el-option
                                        v-for="item in employees"
                                        :key="item.id"
                                        :label="item.name"
                                        :value="item.id">
                                    </el-option>
                                </el-select>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="submitForm">提交</el-button>
                                <el-button @click="resetForm">重置</el-button>
                            </el-form-item>
                        </el-form>
                    </div>
                </el-tab-pane>
                <el-tab-pane label="审批管理" name="approve">
                    <el-table :data="visitRecords" style="width: 100%">
                        <el-table-column prop="visitorName" label="访客姓名"></el-table-column>
                        <el-table-column prop="phone" label="手机号"></el-table-column>
                        <el-table-column prop="purpose" label="来访目的"></el-table-column>
                        <el-table-column prop="status" label="状态">
                            <template slot-scope="scope">
                                <el-tag :type="getStatusType(scope.row.status)">{{getStatusText(scope.row.status)}}</el-tag>
                            </template>
                        </el-table-column>
                        <el-table-column label="操作">
                            <template slot-scope="scope">
                                <el-button 
                                    size="small" 
                                    type="primary" 
                                    @click="handleApprove(scope.row)"
                                    :disabled="scope.row.status !== 0">
                                    审批
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </el-tab-pane>
            </el-tabs>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/element-ui@2.15.13/lib/index.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        new Vue({
            el: '#app',
            data() {
                return {
                    activeTab: 'register',
                    visitorForm: {
                        name: '',
                        phone: '',
                        idCard: '',
                        purpose: '',
                        carNumber: '',
                        employeeId: ''
                    },
                    rules: {
                        name: [{ required: true, message: '请输入访客姓名', trigger: 'blur' }],
                        phone: [{ required: true, message: '请输入手机号', trigger: 'blur' }],
                        idCard: [{ required: true, message: '请输入身份证号', trigger: 'blur' }],
                        purpose: [{ required: true, message: '请输入来访目的', trigger: 'blur' }],
                        employeeId: [{ required: true, message: '请选择被访人', trigger: 'change' }]
                    },
                    employees: [],
                    visitRecords: []
                }
            },
            methods: {
                submitForm() {
                    this.$refs.visitorForm.validate((valid) => {
                        if (valid) {
                            axios.post('/api/visitor/register', this.visitorForm)
                                .then(response => {
                                    if (response.data.code === 200) {
                                        this.$message.success('提交成功');
                                        this.resetForm();
                                    }
                                })
                                .catch(error => {
                                    this.$message.error('提交失败');
                                });
                        }
                    });
                },
                resetForm() {
                    this.$refs.visitorForm.resetFields();
                },
                handleApprove(row) {
                    this.$prompt('请输入审批意见', '审批', {
                        confirmButtonText: '确定',
                        cancelButtonText: '取消'
                    }).then(({ value }) => {
                        axios.post('/api/visit/approve', {
                            recordId: row.id,
                            approved: true,
                            visitTime: new Date(),
                            remark: value
                        }).then(response => {
                            if (response.data.code === 200) {
                                this.$message.success('审批成功');
                                this.loadVisitRecords();
                            }
                        });
                    });
                },
                getStatusType(status) {
                    const types = ['warning', 'success', 'danger', 'info'];
                    return types[status] || 'info';
                },
                getStatusText(status) {
                    const texts = ['待审批', '已通过', '已拒绝', '已完成'];
                    return texts[status] || '未知';
                },
                loadEmployees() {
                    // 加载被访人列表
                    axios.get('/api/employee/list').then(response => {
                        this.employees = response.data.data || [];
                    });
                },
                loadVisitRecords() {
                    // 加载访问记录
                    axios.get('/api/visit/records').then(response => {
                        this.visitRecords = response.data.data || [];
                    });
                }
            },
            created() {
                this.loadEmployees();
                this.loadVisitRecords();
            }
        })
    </script>
</body>
</html>